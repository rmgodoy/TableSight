"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[822],{7822:(e,t,n)=>{n.d(t,{v:()=>d});var r=n(5155),l=n(7569),i=n(3153),s=n(1313),a=n(335),o=n(5731),u=n(9434),c=n(2115);function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return 0===e.length?"":"M ".concat(e[0].x*t," ").concat(e[0].y*t," ")+e.slice(1).map(e=>"L ".concat(e.x*t," ").concat(e.y*t)).join(" ")}function d(e){let{showGrid:t,snapToGrid:n,tokens:d,paths:x,backgroundImage:y,cellSize:f,onMapClick:p,onNewPath:g,onEraseLine:m,onEraseBrush:b,onTokenTorchToggle:v,onPortalToggle:w,selectedTool:k,eraseMode:j,drawMode:M,onTokenMove:L,isPlayerView:E=!1,brushColor:N="#000000",brushSize:P=10,eraseBrushSize:S=20,zoom:C=1,pan:D={x:0,y:0},onZoomChange:z,onPanChange:R,showFogOfWar:A=!1}=e,U=(0,c.useRef)(null),[W,Y]=(0,c.useState)(null),[X,B]=(0,c.useState)(null),[I,_]=(0,c.useState)(null),[K,O]=(0,c.useState)(null),[q,F]=(0,c.useState)(!1),[H,Z]=(0,c.useState)(!1),[G,Q]=(0,c.useState)([]),$=(0,c.useRef)(!1),[J,T]=(0,c.useState)({width:0,height:0}),[V,ee]=(0,c.useState)(!1),et=(0,c.useRef)({x:0,y:0}),[en,er]=(0,c.useState)(C),[el,ei]=(0,c.useState)(D),[es,ea]=(0,c.useState)(null),eo=(0,c.useRef)(null);(0,c.useEffect)(()=>{E||(er(C),ei(D))},[E,C,D]),(0,c.useEffect)(()=>{E&&(er(C),ei(D))},[E,C,D]),(0,c.useEffect)(()=>{let e=()=>{U.current&&T({width:U.current.clientWidth,height:U.current.clientHeight})};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let eu=(0,c.useCallback)(e=>n?{x:Math.round(e.x/f)*f,y:Math.round(e.y/f)*f}:e,[n,f]),ec=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!U.current)return{x:0,y:0};let r=U.current.getBoundingClientRect(),l={x:(e.clientX-r.left-el.x)/en,y:(e.clientY-r.top-el.y)/en};return n&&t?eu(l):l},eh=e=>{if(!U.current)return{x:0,y:0};let t=U.current.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},ed=e=>{if(V)return void ee(!1);E||(q&&G.length>1&&g({points:G,color:"portal"===k?"#ff00ff":N,width:P,blocksLight:"wall"===M}),F(!1),Q([]),eo.current=null,$.current=!1)},ex=(0,c.useCallback)(e=>{let t=(e,t)=>(e.x-t.x)**2+(e.y-t.y)**2,n=[],r=!1;x.forEach(l=>{let i=[];for(let s of l.points)t({x:+s.x,y:+s.y},e)>(S/en)**2?i.push(s):(i.length>1&&(n.push({...l,id:"".concat(l.id,"-split-").concat(Math.random()),points:i}),r=!0),i=[]);i.length>1?n.push({...l,id:l.points.length===i.length?l.id:"".concat(l.id,"-split-").concat(Math.random()),points:i}):1===i.length&&l.points.length>1||(0===i.length&&l.points.length>0?r=!0:r||l.points.length!==i.length||n.push(l))}),r&&b(n)},[x,S,b,en]),ey=(e,t)=>{if(E||!L)return;if(e.stopPropagation(),"Light"===t.type&&"select"===k)return void v(t.id);if("Portal"===t.type&&"select"===k)return void w(t.id);if("select"!==k||"Light"===t.type||"Portal"===t.type)return;Y(t);let n=ec(e,!1);_({x:n.x-t.x*f,y:n.y-t.y*f}),B({x:t.x*f,y:t.y*f})},ef=e=>{if(!W||!L||!I)return;let t=ec(e,!1),n=t.x-I.x,r=t.y-I.y;B({x:n,y:r}),O({x:Math.round(n/f),y:Math.round(r/f)})},ep=e=>{if(!W||!L||!I)return;let t=ec(e,!1),n=t.x-I.x,r=t.y-I.y,l=Math.round(n/f),i=Math.round(r/f);L(W.id,l,i),Y(null),B(null),_(null),O(null)};(0,c.useEffect)(()=>(W?(document.addEventListener("mousemove",ef),document.addEventListener("mouseup",ep)):(document.removeEventListener("mousemove",ef),document.removeEventListener("mouseup",ep)),()=>{document.removeEventListener("mousemove",ef),document.removeEventListener("mouseup",ep)}),[W,D,C,I]),(0,c.useEffect)(()=>{let e=e=>{!E&&(" "!==e.key||V||(e.preventDefault(),ee(!0)))},t=e=>{!E&&" "===e.key&&V&&ee(!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[V,E]);let eg=e=>{let t=x.find(t=>t.id===e.controls);return(0,r.jsx)("div",{className:(0,u.cn)("rounded-full flex items-center justify-center ring-2 ring-white/50 shadow-lg bg-cover bg-center p-1",("Light"===e.type||"Portal"===e.type)&&"cursor-pointer"),style:{backgroundColor:"Light"===e.type||"Portal"===e.type?"transparent":e.color,backgroundImage:e.iconUrl?"url(".concat(e.iconUrl,")"):"none",width:"100%",height:"100%"},children:"Light"===e.type?(0,r.jsx)(l.A,{className:(0,u.cn)("text-white/80 transition-colors w-full h-full",e.torch.enabled&&"text-yellow-300")}):"Portal"===e.type?(null==t?void 0:t.blocksLight)?(0,r.jsx)(i.A,{className:"text-red-300 w-full h-full"}):(0,r.jsx)(s.A,{className:"text-green-300 w-full h-full"}):e.iconUrl?null:"PC"===e.type?(0,r.jsx)(a.A,{className:"text-white/80 w-full h-full"}):"Enemy"===e.type?(0,r.jsx)(o.A,{className:"text-white/80 w-full h-full"}):null})},em=(0,c.useMemo)(()=>{let e=[];return x.filter(e=>e.blocksLight).forEach(t=>{for(let n=0;n<t.points.length-1;n++)e.push({a:{x:t.points[n].x,y:t.points[n].y},b:{x:t.points[n+1].x,y:t.points[n+1].y},width:t.width})}),e},[x]),eb=(0,c.useMemo)(()=>E||A?d.filter(e=>!E||e.visible||"Light"===e.type).filter(e=>e.torch.enabled).map(e=>{var t,n;let r;if("PC"===e.type||"Enemy"===e.type){let t=e.size*f;r={x:e.x*f+t/2,y:e.y*f+t/2}}else r={x:e.x,y:e.y};let l=e.torch.radius*f,i=em.map(e=>({a:{x:e.a.x*en+el.x,y:e.a.y*en+el.y},b:{x:e.b.x*en+el.x,y:e.b.y*en+el.y},width:e.width*en}));return function(e,t,n,r){let l=[];for(let e of t)l.push(e.a,e.b);let i=[{x:0,y:0},{x:n.width,y:0},{x:n.width,y:n.height},{x:0,y:n.height}];for(let t of i)Math.hypot(t.x-e.x,t.y-e.y)<r&&l.push(t);let s=l.reduce((e,t)=>(e.find(e=>e.x===t.x&&e.y===t.y)||e.push(t),e),[]),a=[];for(let t of s){let n=Math.atan2(t.y-e.y,t.x-e.x);a.push(n,n-1e-5,n+1e-5)}for(let e=0;e<360;e+=2){let t=e*Math.PI/180;a.push(t)}let o=[];for(let n of a){let l,s=Math.cos(n),a=Math.sin(n),u={x:e.x+s*(r+1),y:e.y+a*(r+1)},c=null,h=1/0;for(let n of[...t,{a:i[0],b:i[1],width:1},{a:i[1],b:i[2],width:1},{a:i[2],b:i[3],width:1},{a:i[3],b:i[0],width:1}]){let t=function(e,t,n,r){let l,i=e.x,s=e.y,a=t.x-e.x,o=t.y-e.y,u=n.x,c=n.y,h=r.x-n.x,d=r.y-n.y,x=Math.sqrt(a*a+o*o),y=Math.sqrt(h*h+d*d);if(0===x||0===y||1e-9>Math.abs(a/x-h/y)&&1e-9>Math.abs(o/x-d/y))return null;let f=h*o-d*a;if(1e-9>Math.abs(f))return null;let p=(a*(c-s)+o*(i-u))/f;if(Math.abs(a)>1e-9)l=(u+h*p-i)/a;else{if(!(Math.abs(o)>1e-9))return null;l=(c+d*p-s)/o}return l>=-1e-6&&p>=-1e-6&&p<=1.000001?{x:i+a*l,y:s+o*l}:null}(e,u,n.a,n.b);if(t){let n=Math.hypot(t.x-e.x,t.y-e.y);n<h&&(h=n,c=t)}}l=c&&h<=r?c:{x:e.x+s*r,y:e.y+a*r},o.push(l)}return o.sort((t,n)=>Math.atan2(t.y-e.y,t.x-e.x)-Math.atan2(n.y-e.y,n.x-e.x)),o}({x:r.x*en+el.x,y:r.y*en+el.y},i,{width:(null==(t=U.current)?void 0:t.clientWidth)||0,height:(null==(n=U.current)?void 0:n.clientHeight)||0},l*en)}):[],[E,A,d,em,el,en,f]),ev=!E&&("draw"===k||"portal"===k||"erase"===k&&"brush"===j),ew="erase"===k?S:P,ek=()=>{let e=d;E&&(e=d.filter(e=>e.visible&&"Light"!==e.type&&"Portal"!==e.type));let t=x;return E&&(t=x.filter(e=>!e.isPortal)),(0,r.jsxs)("div",{className:"absolute inset-0 origin-top-left",style:{transform:"translate(".concat(el.x,"px, ").concat(el.y,"px) scale(").concat(en,")"),transformOrigin:"0 0"},children:[y&&(0,r.jsx)("img",{src:y,className:"absolute top-0 left-0 pointer-events-none w-auto h-auto max-w-none max-h-none",alt:"Game Map Background",onDragStart:e=>e.preventDefault()}),(0,r.jsxs)("svg",{className:"absolute inset-0 w-full h-full pointer-events-none overflow-visible",children:[t.filter(e=>e.points.length>1).map(e=>{let t=h(e.points,1);return(0,r.jsx)("path",{d:t,stroke:e.color,strokeWidth:e.width,fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeDasharray:e.isPortal?"10,10":void 0,className:(0,u.cn)(e.isPortal&&!e.blocksLight&&"opacity-50")},e.id)}),!E&&q&&G.length>0&&(0,r.jsx)("path",{d:h(G),stroke:"portal"===k?"#ff00ff":N,strokeWidth:P,fill:"rectangle"===k||"circle"===k?"transparent":"none",strokeLinecap:"round",strokeLinejoin:"round",strokeDasharray:"portal"===k?"10,10":void 0})]}),(0,r.jsxs)("div",{className:"absolute inset-0",children:[K&&!E&&W&&(0,r.jsx)("div",{className:"absolute bg-primary/20 border-2 border-dashed border-primary",style:{left:K.x*f,top:K.y*f,width:W.size*f,height:W.size*f}}),e.map(e=>{let t,n;if("PC"===e.type||"Enemy"===e.type){let r=e.size*f;t=.75*r;let l=(r-t)/2;n={x:e.x*f+l,y:e.y*f+l}}else t=.75*f,n={x:e.x-t/2,y:e.y-t/2};return(0,r.jsx)("div",{onMouseDown:t=>ey(t,e),className:(0,u.cn)("absolute flex items-center justify-center",E?"transition-[left,top] duration-300 ease-in-out":"transition-opacity duration-100 ease-in-out",(null==W?void 0:W.id)===e.id&&"opacity-50"),style:{left:n.x,top:n.y,width:t,height:t},children:eg(e)},e.id)}),!E&&W&&X&&(0,r.jsx)("div",{className:"absolute flex items-center justify-center opacity-50 pointer-events-none",style:{left:X.x,top:X.y,width:W.size*f,height:W.size*f},children:eg(W)})]})]})},ej=e=>{let{bright:t}=e;return(0,r.jsx)("div",{className:"absolute inset-0 pointer-events-none",style:{backgroundPosition:"".concat(el.x,"px ").concat(el.y,"px"),backgroundSize:"".concat(f*en,"px ").concat(f*en,"px"),backgroundImage:t?"linear-gradient(to right, hsl(var(--border) / 0.5) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.5) 1px, transparent 1px)":"linear-gradient(to right, hsl(var(--border) / 0.2) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.2) 1px, transparent 1px)"}})};return(0,r.jsx)("div",{ref:U,className:(0,u.cn)("w-full h-full relative overflow-hidden",E?"bg-transparent":"bg-background",!E&&V&&"cursor-grabbing",!E&&!V&&{"cursor-crosshair":"add-pc"===k||"add-enemy"===k||"rectangle"===k||"circle"===k||"add-light"===k,"cursor-default":"select"===k,"cursor-none":ev||"draw"===k||"portal"===k,"cursor-not-allowed":"erase"===k&&"line"===j}),onMouseDown:e=>{if(E)return;if(2===e.button||0===e.button&&(e.altKey||e.metaKey||e.ctrlKey)){ee(!0),et.current={x:e.clientX-el.x,y:e.clientY-el.y},e.preventDefault();return}let t=ec(e,!1),r=n?eu(t):t;"portal"===k||"draw"===k||"rectangle"===k||"circle"===k?("portal"===k||"draw"===k||"rectangle"===k||"circle"===k)&&(F(!0),eo.current=r,Q([r])):"erase"===k?"line"===j?m(r):($.current=!0,ex(r)):"add-pc"===k||"add-enemy"===k?p(Math.floor(t.x/f),Math.floor(t.y/f)):"add-light"===k&&p(r.x,r.y,!0)},onMouseMove:e=>{if(E||ea(eh(e)),E)return;if(V&&R)return void R({x:e.clientX-et.current.x,y:e.clientY-et.current.y});let t=ec(e);if(q&&eo.current){if("draw"===k)Q(e=>[...e,t]);else if("portal"===k)Q([eo.current,t]);else if("rectangle"===k){let e=eo.current;Q([e,{x:t.x,y:e.y},t,{x:e.x,y:t.y},e])}else if("circle"===k){let e=eo.current,n=Math.hypot(t.x-e.x,t.y-e.y),r=[];for(let t=0;t<=60;t++){let l=t/60*2*Math.PI;r.push({x:e.x+n*Math.cos(l),y:e.y+n*Math.sin(l)})}Q(r)}}else $.current&&"brush"===j&&ex(t)},onMouseUp:ed,onMouseLeave:e=>{!E&&(ea(null),(q||H)&&ed(e),$.current&&($.current=!1)),V&&ee(!1)},onMouseEnter:e=>{E||ea(eh(e))},onWheel:e=>{if(E||!z||!R)return;let t=e.deltaY>0?-.1:.1,n=U.current.getBoundingClientRect(),r=e.clientX-n.left,l=e.clientY-n.top,i=Math.max(.1,Math.min(5,en+t)),s=r-(r-el.x)*(i/en);R({x:s,y:l-(l-el.y)*(i/en)}),z(i)},onContextMenu:e=>e.preventDefault(),onDragStart:e=>e.preventDefault(),children:E?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/95",children:(0,r.jsx)(ej,{bright:!1})}),(0,r.jsx)("div",{className:"absolute inset-0",style:{mask:"url(#fog-mask)",WebkitMask:"url(#fog-mask)"},children:(0,r.jsxs)("div",{className:"absolute inset-0 bg-background",children:[(0,r.jsx)(ej,{bright:!0}),(0,r.jsx)(ek,{})]})}),(0,r.jsx)("svg",{width:"0",height:"0",style:{position:"absolute"},children:(0,r.jsx)("defs",{children:(0,r.jsxs)("mask",{id:"fog-mask",maskContentUnits:"userSpaceOnUse",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"black"}),eb.map((e,t)=>e.length>0&&(0,r.jsx)("path",{d:"M ".concat(e.map(e=>"".concat(e.x," ").concat(e.y)).join(" L ")," Z"),fill:"white"},t))]})})})]}):(0,r.jsxs)(r.Fragment,{children:[t&&(0,r.jsx)(ej,{bright:!0}),(0,r.jsx)(ek,{}),ev&&es&&(0,r.jsx)("div",{className:"absolute rounded-full bg-primary/20 border-2 border-primary pointer-events-none",style:{width:ew*en,height:ew*en,left:es.x-ew*en/2,top:es.y-ew*en/2,transformOrigin:"center center"}}),A&&(0,r.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(0,r.jsxs)("svg",{width:"100%",height:"100%",children:[(0,r.jsx)("defs",{children:(0,r.jsxs)("mask",{id:"gm-fog-mask",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"white"}),eb.map((e,t)=>e.length>0&&(0,r.jsx)("path",{d:"M ".concat(e.map(e=>"".concat(e.x," ").concat(e.y)).join(" L ")," Z"),fill:"black"},t))]})}),(0,r.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"rgba(0,0,0,0.5)",mask:"url(#gm-fog-mask)"})]})})]})})}},9434:(e,t,n)=>{n.d(t,{cn:()=>i});var r=n(2596),l=n(9688);function i(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,l.QP)((0,r.$)(t))}}}]);