"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[822],{7822:(e,t,n)=>{n.d(t,{v:()=>d});var r=n(5155),l=n(7569),i=n(3153),s=n(1313),a=n(335),o=n(5731),c=n(9434),u=n(2115);function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return 0===e.length?"":"M ".concat(e[0].x*t," ").concat(e[0].y*t," ")+e.slice(1).map(e=>"L ".concat(e.x*t," ").concat(e.y*t)).join(" ")}function d(e){let{showGrid:t,snapToGrid:n,tokens:d,paths:x,backgroundImage:y,cellSize:p,onMapClick:f,onNewPath:g,onEraseLine:m,onEraseBrush:b,onTokenTorchToggle:v,onPortalToggle:w,selectedTool:j,eraseMode:k,drawMode:M,onTokenMove:L,isPlayerView:E=!1,brushColor:N="#000000",brushSize:P=10,eraseBrushSize:S=20,zoom:C=1,pan:z={x:0,y:0},onZoomChange:D,onPanChange:R,showFogOfWar:A=!1}=e,U=(0,u.useRef)(null),[W,Y]=(0,u.useState)(null),[X,B]=(0,u.useState)(null),[I,_]=(0,u.useState)(null),[K,O]=(0,u.useState)(null),[q,F]=(0,u.useState)(!1),[H,Z]=(0,u.useState)([]),G=(0,u.useRef)(!1),[Q,$]=(0,u.useState)({width:0,height:0}),[J,T]=(0,u.useState)(!1),V=(0,u.useRef)({x:0,y:0}),[ee,et]=(0,u.useState)(C),[en,er]=(0,u.useState)(z),[el,ei]=(0,u.useState)(null),es=(0,u.useRef)(null);(0,u.useEffect)(()=>{E||(et(C),er(z))},[E,C,z]),(0,u.useEffect)(()=>{E&&(et(C),er(z))},[E,C,z]),(0,u.useEffect)(()=>{let e=()=>{U.current&&$({width:U.current.clientWidth,height:U.current.clientHeight})};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let ea=(0,u.useCallback)(e=>n?{x:Math.round(e.x/p)*p,y:Math.round(e.y/p)*p}:e,[n,p]),eo=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!U.current)return{x:0,y:0};let r=U.current.getBoundingClientRect(),l={x:(e.clientX-r.left-en.x)/ee,y:(e.clientY-r.top-en.y)/ee};return n&&t?ea(l):l},ec=e=>{if(!U.current)return{x:0,y:0};let t=U.current.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},eu=e=>{if(J)return void T(!1);E||(q&&H.length>0&&g({points:H,color:"portal"===j?"#ff00ff":N,width:P,blocksLight:"wall"===M}),F(!1),Z([]),es.current=null,G.current=!1)},eh=(0,u.useCallback)(e=>{let t=(e,t)=>(e.x-t.x)**2+(e.y-t.y)**2,n=[],r=!1;x.forEach(l=>{let i=[];for(let s of l.points)t({x:+s.x,y:+s.y},e)>(S/ee)**2?i.push(s):(i.length>1&&(n.push({...l,id:"".concat(l.id,"-split-").concat(Math.random()),points:i}),r=!0),i=[]);i.length>1?n.push({...l,id:l.points.length===i.length?l.id:"".concat(l.id,"-split-").concat(Math.random()),points:i}):1===i.length&&l.points.length>1||(0===i.length&&l.points.length>0?r=!0:r||l.points.length!==i.length||n.push(l))}),r&&b(n)},[x,S,b,ee]),ed=(e,t)=>{if(E||!L)return;if(e.stopPropagation(),"Light"===t.type&&"select"===j)return void v(t.id);if("Portal"===t.type&&"select"===j)return void w(t.id);if("select"!==j||"Light"===t.type||"Portal"===t.type)return;Y(t);let n=eo(e,!1);_({x:n.x-t.x*p,y:n.y-t.y*p}),B({x:t.x*p,y:t.y*p})},ex=e=>{if(!W||!L||!I)return;let t=eo(e,!1),n=t.x-I.x,r=t.y-I.y;B({x:n,y:r}),W.size,O({x:Math.round(n/p),y:Math.round(r/p)})},ey=e=>{if(!W||!L||!I)return;let t=eo(e,!1),n=t.x-I.x,r=t.y-I.y,l=Math.round(n/p),i=Math.round(r/p);L(W.id,l,i),Y(null),B(null),_(null),O(null)};(0,u.useEffect)(()=>(W?(document.addEventListener("mousemove",ex),document.addEventListener("mouseup",ey)):(document.removeEventListener("mousemove",ex),document.removeEventListener("mouseup",ey)),()=>{document.removeEventListener("mousemove",ex),document.removeEventListener("mouseup",ey)}),[W,z,C,I]),(0,u.useEffect)(()=>{let e=e=>{!E&&(" "!==e.key||J||(e.preventDefault(),T(!0)))},t=e=>{!E&&" "===e.key&&J&&T(!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[J,E]);let ep=e=>{let t=x.find(t=>t.id===e.controls);return(0,r.jsx)("div",{className:(0,c.cn)("rounded-full flex items-center justify-center ring-2 ring-white/50 shadow-lg bg-cover bg-center",("Light"===e.type||"Portal"===e.type)&&"cursor-pointer"),style:{backgroundColor:"Light"===e.type||"Portal"===e.type?"transparent":e.color,backgroundImage:e.iconUrl?"url(".concat(e.iconUrl,")"):"none",width:"100%",height:"100%"},children:(0,r.jsx)("div",{style:{transform:"scale(".concat(.5*e.size,")")},children:"Light"===e.type?(0,r.jsx)(l.A,{className:(0,c.cn)("text-white/80 transition-colors",e.torch.enabled&&"text-yellow-300")}):"Portal"===e.type?(null==t?void 0:t.blocksLight)?(0,r.jsx)(i.A,{className:"text-red-300"}):(0,r.jsx)(s.A,{className:"text-green-300"}):e.iconUrl?null:"PC"===e.type?(0,r.jsx)(a.A,{className:"text-white/80"}):"Enemy"===e.type?(0,r.jsx)(o.A,{className:"text-white/80"}):null})})},ef=(0,u.useMemo)(()=>{let e=[];return x.filter(e=>e.blocksLight).forEach(t=>{for(let n=0;n<t.points.length-1;n++)e.push({a:{x:t.points[n].x,y:t.points[n].y},b:{x:t.points[n+1].x,y:t.points[n+1].y},width:t.width})}),e},[x]),eg=(0,u.useMemo)(()=>E||A?d.filter(e=>!E||e.visible||"Light"===e.type).filter(e=>e.torch.enabled).map(e=>{var t,n;let r;if("PC"===e.type||"Enemy"===e.type){let t=e.size*p;r={x:e.x*p+t/2,y:e.y*p+t/2}}else r={x:e.x,y:e.y};let l=e.torch.radius*p,i=ef.map(e=>({a:{x:e.a.x*ee+en.x,y:e.a.y*ee+en.y},b:{x:e.b.x*ee+en.x,y:e.b.y*ee+en.y},width:e.width*ee}));return function(e,t,n,r){let l=[];for(let e of t)l.push(e.a,e.b);let i=[{x:0,y:0},{x:n.width,y:0},{x:n.width,y:n.height},{x:0,y:n.height}];for(let t of i)Math.hypot(t.x-e.x,t.y-e.y)<r&&l.push(t);let s=l.reduce((e,t)=>(e.find(e=>e.x===t.x&&e.y===t.y)||e.push(t),e),[]),a=[];for(let t of s){let n=Math.atan2(t.y-e.y,t.x-e.x);a.push(n,n-1e-5,n+1e-5)}for(let e=0;e<360;e+=2){let t=e*Math.PI/180;a.push(t)}let o=[];for(let n of a){let l,s=Math.cos(n),a=Math.sin(n),c={x:e.x+s*(r+1),y:e.y+a*(r+1)},u=null,h=1/0;for(let n of[...t,{a:i[0],b:i[1],width:1},{a:i[1],b:i[2],width:1},{a:i[2],b:i[3],width:1},{a:i[3],b:i[0],width:1}]){let t=function(e,t,n,r){let l,i=e.x,s=e.y,a=t.x-e.x,o=t.y-e.y,c=n.x,u=n.y,h=r.x-n.x,d=r.y-n.y,x=Math.sqrt(a*a+o*o),y=Math.sqrt(h*h+d*d);if(0===x||0===y||1e-9>Math.abs(a/x-h/y)&&1e-9>Math.abs(o/x-d/y))return null;let p=h*o-d*a;if(1e-9>Math.abs(p))return null;let f=(a*(u-s)+o*(i-c))/p;if(Math.abs(a)>1e-9)l=(c+h*f-i)/a;else{if(!(Math.abs(o)>1e-9))return null;l=(u+d*f-s)/o}return l>=-1e-6&&f>=-1e-6&&f<=1.000001?{x:i+a*l,y:s+o*l}:null}(e,c,n.a,n.b);if(t){let n=Math.hypot(t.x-e.x,t.y-e.y);n<h&&(h=n,u=t)}}l=u&&h<=r?u:{x:e.x+s*r,y:e.y+a*r},o.push(l)}return o.sort((t,n)=>Math.atan2(t.y-e.y,t.x-e.x)-Math.atan2(n.y-e.y,n.x-e.x)),o}({x:r.x*ee+en.x,y:r.y*ee+en.y},i,{width:(null==(t=U.current)?void 0:t.clientWidth)||0,height:(null==(n=U.current)?void 0:n.clientHeight)||0},l*ee)}):[],[E,A,d,ef,en,ee,p]),em=!E&&("draw"===j||"portal"===j||"erase"===j&&"brush"===k),eb="erase"===j?S:P,ev=()=>{let e=d;E&&(e=d.filter(e=>e.visible&&"Light"!==e.type&&"Portal"!==e.type));let t=x;return E&&(t=x.filter(e=>!e.isPortal)),(0,r.jsxs)("div",{className:"absolute inset-0 origin-top-left",style:{transform:"translate(".concat(en.x,"px, ").concat(en.y,"px) scale(").concat(ee,")"),transformOrigin:"0 0"},children:[y&&(0,r.jsx)("img",{src:y,className:"absolute top-0 left-0 pointer-events-none w-auto h-auto max-w-none max-h-none",alt:"Game Map Background"}),(0,r.jsxs)("svg",{className:"absolute inset-0 w-full h-full pointer-events-none overflow-visible",children:[t.filter(e=>e.points.length>1).map(e=>{let t=h(e.points,1);return(0,r.jsx)("path",{d:t,stroke:e.color,strokeWidth:e.width,fill:"none",strokeLinecap:"round",strokeLinejoin:"round",strokeDasharray:e.isPortal?"10,10":void 0,className:(0,c.cn)(e.isPortal&&!e.blocksLight&&"opacity-50")},e.id)}),!E&&q&&H.length>0&&(0,r.jsx)("path",{d:h(H),stroke:"portal"===j?"#ff00ff":N,strokeWidth:P,fill:"rectangle"===j||"circle"===j?"transparent":"none",strokeLinecap:"round",strokeLinejoin:"round",strokeDasharray:"portal"===j?"10,10":void 0})]}),(0,r.jsxs)("div",{className:"absolute inset-0",children:[K&&!E&&W&&(0,r.jsx)("div",{className:"absolute bg-primary/20 border-2 border-dashed border-primary",style:{left:K.x*p,top:K.y*p,width:W.size*p,height:W.size*p}}),e.map(e=>{let t=p,n={x:0,y:0};return"PC"===e.type||"Enemy"===e.type?(t=e.size*p,n={x:e.x*p,y:e.y*p}):(t=p,n={x:e.x-t/2,y:e.y-t/2}),(0,r.jsx)("div",{onMouseDown:t=>ed(t,e),className:(0,c.cn)("absolute flex items-center justify-center",E?"transition-[left,top] duration-300 ease-in-out":"transition-opacity duration-100 ease-in-out",(null==W?void 0:W.id)===e.id&&"opacity-50"),style:{left:n.x,top:n.y,width:t,height:t},children:ep(e)},e.id)}),!E&&W&&X&&(0,r.jsx)("div",{className:"absolute flex items-center justify-center opacity-50 pointer-events-none",style:{left:X.x,top:X.y,width:W.size*p,height:W.size*p},children:ep(W)})]})]})},ew=e=>{let{bright:t}=e;return(0,r.jsx)("div",{className:"absolute inset-0 pointer-events-none",style:{backgroundPosition:"".concat(en.x,"px ").concat(en.y,"px"),backgroundSize:"".concat(p*ee,"px ").concat(p*ee,"px"),backgroundImage:t?"linear-gradient(to right, hsl(var(--border) / 0.5) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.5) 1px, transparent 1px)":"linear-gradient(to right, hsl(var(--border) / 0.2) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.2) 1px, transparent 1px)"}})};return(0,r.jsx)("div",{ref:U,className:(0,c.cn)("w-full h-full relative overflow-hidden",E?"bg-transparent":"bg-background",!E&&J&&"cursor-grabbing",!E&&!J&&{"cursor-crosshair":"add-pc"===j||"add-enemy"===j||"rectangle"===j||"circle"===j,"cursor-default":"select"===j,"cursor-none":em||"draw"===j,"cursor-not-allowed":"erase"===j&&"line"===k}),onMouseDown:e=>{if(E)return;if(2===e.button||0===e.button&&(e.altKey||e.metaKey||e.ctrlKey)){T(!0),V.current={x:e.clientX-en.x,y:e.clientY-en.y},e.preventDefault();return}let t=eo(e);"draw"===j||"rectangle"===j||"circle"===j||"portal"===j?(F(!0),es.current=t,Z([t])):"erase"===j?"line"===k?m(t):(G.current=!0,eh(t)):("add-pc"===j||"add-enemy"===j)&&f(Math.floor(t.x/p),Math.floor(t.y/p))},onMouseMove:e=>{if(E||ei(ec(e)),E)return;if(J&&R)return void R({x:e.clientX-V.current.x,y:e.clientY-V.current.y});let t=eo(e);if(q&&es.current){if("draw"===j||"portal"===j)Z(e=>[...e,t]);else if("rectangle"===j){let e=es.current;Z([e,{x:t.x,y:e.y},t,{x:e.x,y:t.y},e])}else if("circle"===j){let e=es.current,n=Math.hypot(t.x-e.x,t.y-e.y),r=[];for(let t=0;t<=60;t++){let l=t/60*2*Math.PI;r.push({x:e.x+n*Math.cos(l),y:e.y+n*Math.sin(l)})}Z(r)}}else G.current&&"brush"===k&&eh(t)},onMouseUp:eu,onMouseLeave:e=>{!E&&(ei(null),q&&eu(e),G.current&&(G.current=!1)),J&&T(!1)},onMouseEnter:e=>{E||ei(ec(e))},onWheel:e=>{if(E||!D||!R)return;let t=e.deltaY>0?-.1:.1,n=U.current.getBoundingClientRect(),r=e.clientX-n.left,l=e.clientY-n.top,i=Math.max(.1,Math.min(5,ee+t)),s=r-(r-en.x)*(i/ee);R({x:s,y:l-(l-en.y)*(i/ee)}),D(i)},onContextMenu:e=>e.preventDefault(),onDragStart:e=>e.preventDefault(),children:E?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-black/95",children:(0,r.jsx)(ew,{bright:!1})}),(0,r.jsx)("div",{className:"absolute inset-0",style:{mask:"url(#fog-mask)",WebkitMask:"url(#fog-mask)"},children:(0,r.jsxs)("div",{className:"absolute inset-0 bg-background",children:[(0,r.jsx)(ew,{bright:!0}),(0,r.jsx)(ev,{})]})}),(0,r.jsx)("svg",{width:"0",height:"0",style:{position:"absolute"},children:(0,r.jsx)("defs",{children:(0,r.jsxs)("mask",{id:"fog-mask",maskContentUnits:"userSpaceOnUse",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"black"}),eg.map((e,t)=>e.length>0&&(0,r.jsx)("path",{d:"M ".concat(e.map(e=>"".concat(e.x," ").concat(e.y)).join(" L ")," Z"),fill:"white"},t))]})})})]}):(0,r.jsxs)(r.Fragment,{children:[t&&(0,r.jsx)(ew,{bright:!0}),(0,r.jsx)(ev,{}),em&&el&&(0,r.jsx)("div",{className:"absolute rounded-full bg-primary/20 border-2 border-primary pointer-events-none",style:{width:eb*ee,height:eb*ee,left:el.x-eb*ee/2,top:el.y-eb*ee/2,transformOrigin:"center center"}}),A&&(0,r.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(0,r.jsxs)("svg",{width:"100%",height:"100%",children:[(0,r.jsx)("defs",{children:(0,r.jsxs)("mask",{id:"gm-fog-mask",children:[(0,r.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"white"}),eg.map((e,t)=>e.length>0&&(0,r.jsx)("path",{d:"M ".concat(e.map(e=>"".concat(e.x," ").concat(e.y)).join(" L ")," Z"),fill:"black"},t))]})}),(0,r.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"rgba(0,0,0,0.5)",mask:"url(#gm-fog-mask)"})]})})]})})}},9434:(e,t,n)=>{n.d(t,{cn:()=>i});var r=n(2596),l=n(9688);function i(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return(0,l.QP)((0,r.$)(t))}}}]);