"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[822],{7822:(e,t,r)=>{r.d(t,{v:()=>x});var n=r(5155),l=r(7569),i=r(3153),a=r(1313),s=r(335),o=r(2643),u=r(4607),c=r(9434),d=r(2115);function h(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=arguments.length>2?arguments[2]:void 0;return e&&0!==e.length?e.map(e=>{if(0===e.length)return"";let n="M ".concat(e[0].x*t," ").concat(e[0].y*t," ")+e.slice(1).map(e=>"L ".concat(e.x*t," ").concat(e.y*t)).join(" ");return r?n+" Z":n}).join(" "):""}function x(e){let{showGrid:t,snapToGrid:r,smartMode:x,tokens:y,paths:f,backgroundImage:p,cellSize:g,onMapClick:m,onNewPath:b,onEraseLine:w,onEraseBrush:v,onTokenTorchToggle:j,onPortalToggle:k,selectedTool:M,eraseMode:L,drawMode:N,onTokenMove:E,isPlayerView:X=!1,brushColor:Y="#000000",brushSize:P=10,eraseBrushSize:S=20,zoom:C=1,pan:z={x:0,y:0},onZoomChange:D,onPanChange:W,onPlayerPanChange:R,onPlayerZoomChange:A,showFogOfWar:U=!1,hoveredTokenId:H=null,playerPan:B={x:0,y:0},playerZoom:I=1,playerViewport:_=null,showPlayerViewport:K=!1,followedTokenId:O=null}=e,Z=(0,d.useRef)(null),[q,F]=(0,d.useState)(null),[G,Q]=(0,d.useState)(null),[$,J]=(0,d.useState)(null),[T,V]=(0,d.useState)(null),[ee,et]=(0,d.useState)(!1),[er,en]=(0,d.useState)([]),el=(0,d.useRef)(!1),[ei,ea]=(0,d.useState)({width:0,height:0}),[es,eo]=(0,d.useState)(!1),eu=(0,d.useRef)({x:0,y:0}),[ec,ed]=(0,d.useState)(C),[eh,ex]=(0,d.useState)(z),[ey,ef]=(0,d.useState)(null),ep=(0,d.useRef)(null),[eg,em]=(0,d.useState)(!1),eb=(0,d.useRef)({mouseX:0,mouseY:0,panX:0,panY:0}),[ew,ev]=(0,d.useState)(!1),ej=(0,d.useRef)({mouseX:0,mouseY:0,panX:0,panY:0,zoom:1,viewportWidth:0});(0,d.useEffect)(()=>{X||(ed(C),ex(z))},[X,C,z]),(0,d.useEffect)(()=>{X&&(ed(C),ex(z))},[X,C,z]),(0,d.useEffect)(()=>{let e=()=>{Z.current&&ea({width:Z.current.clientWidth,height:Z.current.clientHeight})};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let ek=(0,d.useCallback)(e=>r?{x:Math.round(e.x/g)*g,y:Math.round(e.y/g)*g}:e,[r,g]),eM=function(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(!Z.current)return{x:0,y:0};let n=Z.current.getBoundingClientRect(),l={x:(e.clientX-n.left-eh.x)/ec,y:(e.clientY-n.top-eh.y)/ec};return r&&t?ek(l):l},eL=e=>{if(!Z.current)return{x:0,y:0};let t=Z.current.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}},eN=e=>{if(es)return void eo(!1);if(!X){if(ee&&er.length>1){let e="rectangle"===M||"circle"===M||"portal"===M||"hidden-wall"===M||"draw"===M&&x;b({points:[er],color:"portal"===M?"#ff00ff":"hidden-wall"===M?"#000000":Y,width:P,blocksLight:"wall"===N,tool:M,isClosed:e})}et(!1),en([]),ep.current=null,el.current=!1}},eE=(0,d.useCallback)(e=>{let t=(e,t)=>(e.x-t.x)**2+(e.y-t.y)**2,r=[],n=!1;f.forEach(l=>{let i=!1;for(let r of l.points){for(let n of r)if(t(n,e)<=(S/ec)**2){i=!0;break}if(i)break}i?n=!0:r.push(l)}),n&&v(r)},[f,S,v,ec]),eX=(e,t)=>{if(X||!E)return;if(e.stopPropagation(),"Light"===t.type&&"select"===M)return void j(t.id);if("Portal"===t.type&&"select"===M)return void k(t.id);if("select"!==M||"Light"===t.type||"Portal"===t.type)return;F(t);let r=eM(e,!1);J({x:r.x-t.x*g,y:r.y-t.y*g}),Q({x:t.x*g,y:t.y*g})},eY=e=>{if(ew&&R&&A&&_&&I){let t=e.clientX-ej.current.mouseX,r=(ej.current.viewportWidth+t)/ej.current.viewportWidth,n=Math.max(.1,Math.min(5,ej.current.zoom/r)),l=ej.current.zoom,i={x:ej.current.panX,y:ej.current.panY},a={x:(-i.x+_.width/2)/l,y:(-i.y+_.height/2)/l},s={x:-(a.x*n-_.width/2),y:-(a.y*n-_.height/2)};A(n),R(s);return}if(eg&&R){let t=e.clientX-eb.current.mouseX,r=e.clientY-eb.current.mouseY,n=t/ec,l=r/ec;R({x:eb.current.panX-n*I,y:eb.current.panY-l*I});return}if(!q||!E||!$)return;let t=eM(e,!1),r=t.x-$.x,n=t.y-$.y;Q({x:r,y:n}),V({x:Math.round(r/g),y:Math.round(n/g)})},eP=e=>{if(ew)return void ev(!1);if(eg)return void em(!1);if(!q||!E||!$)return;let t=eM(e,!1),r=t.x-$.x,n=t.y-$.y,l=Math.round(r/g),i=Math.round(n/g);E(q.id,l,i),F(null),Q(null),J(null),V(null)};(0,d.useEffect)(()=>(q||eg||ew?(document.addEventListener("mousemove",eY),document.addEventListener("mouseup",eP)):(document.removeEventListener("mousemove",eY),document.removeEventListener("mouseup",eP)),()=>{document.removeEventListener("mousemove",eY),document.removeEventListener("mouseup",eP)}),[q,z,C,$,eg,ew,B,I]),(0,d.useEffect)(()=>{let e=e=>{!X&&(" "!==e.key||es||(e.preventDefault(),eo(!0)))},t=e=>{!X&&" "===e.key&&es&&eo(!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[es,X]);let eS=e=>{if("Enemy"!==e.type||!e.hp||e.hp.current<=0)return"ring-white/50";let t=e.hp.current/e.hp.max*100;return t>75?"ring-green-500":t>50?"ring-yellow-500":t>25?"ring-orange-500":t>10?"ring-red-500":"ring-red-800"},eC=e=>{let t=f.find(t=>t.id===e.controls),r=!X&&H===e.id,d=!X&&"Enemy"===e.type&&!e.visible,h="Enemy"===e.type&&e.hp&&e.hp.current<=0,x=eS(e);return(0,n.jsx)("div",{className:"relative w-full h-full",children:(0,n.jsxs)("div",{className:(0,c.cn)("relative rounded-full flex items-center justify-center ring-2 shadow-lg bg-cover bg-center w-full h-full",x,r&&"bg-primary/30",("Light"===e.type||"Portal"===e.type)&&"cursor-pointer"),style:{backgroundColor:"Light"===e.type||"Portal"===e.type?"transparent":e.color,backgroundImage:e.iconUrl?"url(".concat(e.iconUrl,")"):"none"},children:["Light"===e.type?(0,n.jsx)(l.A,{className:(0,c.cn)("text-white/80 transition-colors w-full h-full",e.torch.enabled&&"text-yellow-300")}):"Portal"===e.type?(null==t?void 0:t.blocksLight)?(0,n.jsx)(i.A,{className:"text-red-300 w-full h-full"}):(0,n.jsx)(a.A,{className:"text-green-300 w-full h-full"}):e.iconUrl?null:"PC"===e.type?(0,n.jsx)(s.A,{className:"text-white/80 w-full h-full"}):"Enemy"===e.type?(0,n.jsx)(o.A,{className:"text-white/80 w-full h-full"}):null,h&&!d&&(0,n.jsx)("div",{className:"absolute inset-0 bg-black/50 rounded-full flex items-center justify-center",children:(0,n.jsx)(o.A,{className:"w-1/2 h-1/2 text-white/90"})}),d&&(0,n.jsx)("div",{className:"absolute inset-0 bg-black/50 rounded-full flex items-center justify-center",children:(0,n.jsx)(u.A,{className:"w-1/2 h-1/2 text-white/70"})}),r&&(0,n.jsx)("div",{className:"absolute -inset-1 rounded-full border-4 border-primary animate-pulse",style:{animationDuration:"1.2s"}})]})})},ez=(0,d.useMemo)(()=>{let e=[];return f.filter(e=>e.blocksLight).forEach(t=>{t.points.forEach(r=>{for(let n=0;n<r.length;n++){let l=t.isClosed?(n+1)%r.length:n+1;l<r.length&&e.push({a:r[n],b:r[l],width:t.width})}})}),e},[f]),eD=(0,d.useMemo)(()=>X||U?y.filter(e=>!X||e.visible||"Light"===e.type).filter(e=>e.torch.enabled).map(e=>{var t,r;let n;if("PC"===e.type||"Enemy"===e.type){let t=e.size*g;n={x:e.x*g+t/2,y:e.y*g+t/2}}else n={x:e.x,y:e.y};let l=e.torch.radius*g,i=ez.map(e=>({a:{x:e.a.x*ec+eh.x,y:e.a.y*ec+eh.y},b:{x:e.b.x*ec+eh.x,y:e.b.y*ec+eh.y},width:e.width*ec}));return function(e,t,r,n){let l=[];for(let e of t)l.push(e.a,e.b);let i=[{x:0,y:0},{x:r.width,y:0},{x:r.width,y:r.height},{x:0,y:r.height}];for(let t of i)Math.hypot(t.x-e.x,t.y-e.y)<n&&l.push(t);let a=l.reduce((e,t)=>(e.find(e=>e.x===t.x&&e.y===t.y)||e.push(t),e),[]),s=[];for(let t of a){let r=Math.atan2(t.y-e.y,t.x-e.x);s.push(r,r-1e-5,r+1e-5)}for(let e=0;e<360;e+=2){let t=e*Math.PI/180;s.push(t)}let o=[];for(let r of s){let l,a=Math.cos(r),s=Math.sin(r),u={x:e.x+a*(n+1),y:e.y+s*(n+1)},c=null,d=1/0;for(let r of[...t,{a:i[0],b:i[1],width:1},{a:i[1],b:i[2],width:1},{a:i[2],b:i[3],width:1},{a:i[3],b:i[0],width:1}]){let t=function(e,t,r,n){let l,i=e.x,a=e.y,s=t.x-e.x,o=t.y-e.y,u=r.x,c=r.y,d=n.x-r.x,h=n.y-r.y,x=Math.sqrt(s*s+o*o),y=Math.sqrt(d*d+h*h);if(0===x||0===y||1e-9>Math.abs(s/x-d/y)&&1e-9>Math.abs(o/x-h/y))return null;let f=d*o-h*s;if(1e-9>Math.abs(f))return null;let p=(s*(c-a)+o*(i-u))/f;if(Math.abs(s)>1e-9)l=(u+d*p-i)/s;else{if(!(Math.abs(o)>1e-9))return null;l=(c+h*p-a)/o}return l>=-1e-6&&p>=-1e-6&&p<=1.000001?{x:i+s*l,y:a+o*l}:null}(e,u,r.a,r.b);if(t){let r=Math.hypot(t.x-e.x,t.y-e.y);r<d&&(d=r,c=t)}}l=c&&d<=n?c:{x:e.x+a*n,y:e.y+s*n},o.push(l)}return o.sort((t,r)=>Math.atan2(t.y-e.y,t.x-e.x)-Math.atan2(r.y-e.y,r.x-e.x)),o}({x:n.x*ec+eh.x,y:n.y*ec+eh.y},i,{width:(null==(t=Z.current)?void 0:t.clientWidth)||0,height:(null==(r=Z.current)?void 0:r.clientHeight)||0},l*ec)}):[],[X,U,y,ez,eh,ec,g]),eW=!X&&("draw"===M||"portal"===M||"hidden-wall"===M||"erase"===M&&"brush"===L),eR="erase"===M?S:P,eA=()=>{let e=y;X&&(e=y.filter(e=>e.visible&&"Light"!==e.type&&"Portal"!==e.type));let t=f;return X&&(t=f.filter(e=>!e.isPortal&&(!e.isHiddenWall||!!e.blocksLight))),(0,n.jsxs)("div",{className:"absolute inset-0 origin-top-left",style:{transform:"translate(".concat(eh.x,"px, ").concat(eh.y,"px) scale(").concat(ec,")"),transformOrigin:"0 0"},children:[p&&(0,n.jsx)("img",{src:p,className:"absolute top-0 left-0 pointer-events-none w-auto h-auto max-w-none max-h-none",alt:"Game Map Background",onDragStart:e=>e.preventDefault()}),(0,n.jsxs)("svg",{className:"absolute inset-0 w-full h-full pointer-events-none overflow-visible",children:[t.map(e=>{let t=h(e.points,1,e.isClosed);return(0,n.jsx)("path",{d:t,stroke:e.color,strokeWidth:e.width,fill:"none",fillRule:"evenodd",strokeLinecap:"round",strokeLinejoin:"round",strokeDasharray:e.isPortal||e.isHiddenWall?"10,10":void 0,className:(0,c.cn)((e.isPortal||e.isHiddenWall)&&!e.blocksLight&&"opacity-50")},e.id)}),!X&&ee&&er.length>0&&(0,n.jsx)("path",{d:h([er],1,"draw"!==M||x),stroke:"portal"===M?"#ff00ff":"hidden-wall"===M?"#000000":Y,strokeWidth:P,fill:"none",fillRule:"evenodd",strokeLinecap:"round",strokeLinejoin:"round",strokeDasharray:"portal"===M||"hidden-wall"===M?"10,10":void 0})]}),(0,n.jsxs)("div",{className:"absolute inset-0",children:[T&&!X&&q&&(0,n.jsx)("div",{className:"absolute bg-primary/20 border-2 border-dashed border-primary",style:{left:T.x*g,top:T.y*g,width:q.size*g,height:q.size*g}}),e.map(e=>{let t,r;if("PC"===e.type||"Enemy"===e.type){let n=e.size*g;t=.9*n;let l=(n-t)/2;r={x:e.x*g+l,y:e.y*g+l}}else t=.9*g,r={x:e.x-t/2,y:e.y-t/2};return(0,n.jsx)("div",{onMouseDown:t=>eX(t,e),className:(0,c.cn)("absolute flex items-center justify-center",X?"transition-[left,top] duration-300 ease-in-out":"transition-opacity duration-100 ease-in-out",(null==q?void 0:q.id)===e.id&&"opacity-50"),style:{left:r.x,top:r.y,width:t,height:t},children:eC(e)},e.id)}),!X&&q&&G&&(0,n.jsx)("div",{className:"absolute flex items-center justify-center opacity-50 pointer-events-none",style:{left:G.x,top:G.y,width:q.size*g,height:q.size*g},children:eC(q)})]})]})},eU=e=>{let{bright:t}=e;return(0,n.jsx)("div",{className:"absolute inset-0 pointer-events-none",style:{backgroundPosition:"".concat(eh.x,"px ").concat(eh.y,"px"),backgroundSize:"".concat(g*ec,"px ").concat(g*ec,"px"),backgroundImage:t?"linear-gradient(to right, hsl(var(--border) / 0.5) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.5) 1px, transparent 1px)":"linear-gradient(to right, hsl(var(--border) / 0.2) 1px, transparent 1px), linear-gradient(to bottom, hsl(var(--border) / 0.2) 1px, transparent 1px)"}})};return(0,n.jsx)("div",{ref:Z,className:(0,c.cn)("w-full h-full relative overflow-hidden",X?"bg-transparent":"bg-background",!X&&es&&"cursor-grabbing",!X&&!es&&{"cursor-crosshair":"add-pc"===M||"add-enemy"===M||"rectangle"===M||"circle"===M||"add-light"===M,"cursor-default":"select"===M,"cursor-none":eW||"draw"===M||"portal"===M||"hidden-wall"===M,"cursor-not-allowed":"erase"===M&&"line"===L}),onMouseDown:e=>{if(X)return;if(2===e.button||0===e.button&&(e.altKey||e.metaKey||e.ctrlKey)){eo(!0),eu.current={x:e.clientX-eh.x,y:e.clientY-eh.y},e.preventDefault();return}let t=eM(e,!1),n=r?ek(t):t;"portal"===M||"hidden-wall"===M||"draw"===M||"rectangle"===M||"circle"===M?("portal"===M||"hidden-wall"===M||"draw"===M||"rectangle"===M||"circle"===M)&&(et(!0),ep.current=n,en([n])):"erase"===M?"line"===L?w(n):(el.current=!0,eE(n)):"add-pc"===M||"add-enemy"===M?m(Math.floor(t.x/g),Math.floor(t.y/g)):"add-light"===M&&m(n.x,n.y,!0)},onMouseMove:e=>{if(X||ef(eL(e)),X)return;if(es&&W)return void W({x:e.clientX-eu.current.x,y:e.clientY-eu.current.y});let t=eM(e);if(ee&&ep.current){if("draw"===M)en(e=>[...e,t]);else if("portal"===M||"hidden-wall"===M)en([ep.current,t]);else if("rectangle"===M){let e=ep.current;en([e,{x:t.x,y:e.y},t,{x:e.x,y:t.y},e])}else if("circle"===M){let e=ep.current,r=Math.hypot(t.x-e.x,t.y-e.y),n=[];for(let t=0;t<=60;t++){let l=t/60*2*Math.PI;n.push({x:e.x+r*Math.cos(l),y:e.y+r*Math.sin(l)})}en(n)}}else el.current&&"brush"===L&&eE(t)},onMouseUp:eN,onMouseLeave:e=>{!X&&(ef(null),ee&&eN(e),el.current&&(el.current=!1)),es&&eo(!1)},onMouseEnter:e=>{X||ef(eL(e))},onWheel:e=>{if(X||!D||!W)return;let t=e.deltaY>0?-.1:.1,r=Z.current.getBoundingClientRect(),n=e.clientX-r.left,l=e.clientY-r.top,i=Math.max(.1,Math.min(5,ec+t)),a=n-(n-eh.x)*(i/ec);W({x:a,y:l-(l-eh.y)*(i/ec)}),D(i)},onContextMenu:e=>e.preventDefault(),onDragStart:e=>e.preventDefault(),children:X?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"absolute inset-0 bg-black/95",children:(0,n.jsx)(eU,{bright:!1})}),(0,n.jsx)("div",{className:"absolute inset-0",style:{mask:"url(#fog-mask)",WebkitMask:"url(#fog-mask)"},children:(0,n.jsxs)("div",{className:"absolute inset-0 bg-background",children:[(0,n.jsx)(eU,{bright:!0}),(0,n.jsx)(eA,{})]})}),(0,n.jsx)("svg",{width:"0",height:"0",style:{position:"absolute"},children:(0,n.jsx)("defs",{children:(0,n.jsxs)("mask",{id:"fog-mask",maskContentUnits:"userSpaceOnUse",children:[(0,n.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"black"}),eD.map((e,t)=>e.length>0&&(0,n.jsx)("path",{d:"M ".concat(e.map(e=>"".concat(e.x," ").concat(e.y)).join(" L ")," Z"),fill:"white"},t))]})})})]}):(0,n.jsxs)(n.Fragment,{children:[t&&(0,n.jsx)(eU,{bright:!0}),(0,n.jsx)(eA,{}),(0,n.jsx)(()=>{if(X||!_||!K||!I)return null;let e={x:-B.x/I,y:-B.y/I},t={width:_.width/I,height:_.height/I},r=e.x*ec+eh.x,l=e.y*ec+eh.y,i=t.width*ec,a=t.height*ec;return(0,n.jsx)("div",{className:(0,c.cn)("absolute border-2 border-dashed border-blue-500",eg&&"cursor-grabbing",!O&&!eg&&"cursor-grab",O&&"cursor-not-allowed"),style:{left:"".concat(r,"px"),top:"".concat(l,"px"),width:"".concat(i,"px"),height:"".concat(a,"px")},onMouseDown:e=>{O||(e.stopPropagation(),em(!0),eb.current={mouseX:e.clientX,mouseY:e.clientY,panX:B.x,panY:B.y})},children:!O&&(0,n.jsx)("div",{onMouseDown:e=>{O||(e.stopPropagation(),ev(!0),ej.current={mouseX:e.clientX,mouseY:e.clientY,panX:B.x,panY:B.y,zoom:I,viewportWidth:i})},className:"absolute -bottom-2 -right-2 w-4 h-4 bg-blue-500 border-2 border-background rounded-full cursor-nwse-resize"})})},{}),eW&&ey&&(0,n.jsx)("div",{className:"absolute rounded-full bg-primary/20 border-2 border-primary pointer-events-none",style:{width:eR*ec,height:eR*ec,left:ey.x-eR*ec/2,top:ey.y-eR*ec/2,transformOrigin:"center center"}}),U&&(0,n.jsx)("div",{className:"absolute inset-0 pointer-events-none",children:(0,n.jsxs)("svg",{width:"100%",height:"100%",children:[(0,n.jsx)("defs",{children:(0,n.jsxs)("mask",{id:"gm-fog-mask",children:[(0,n.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"white"}),eD.map((e,t)=>e.length>0&&(0,n.jsx)("path",{d:"M ".concat(e.map(e=>"".concat(e.x," ").concat(e.y)).join(" L ")," Z"),fill:"black"},t))]})}),(0,n.jsx)("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"rgba(0,0,0,0.5)",mask:"url(#gm-fog-mask)"})]})})]})})}},9434:(e,t,r)=>{r.d(t,{cn:()=>i});var n=r(2596),l=r(9688);function i(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,l.QP)((0,n.$)(t))}}}]);